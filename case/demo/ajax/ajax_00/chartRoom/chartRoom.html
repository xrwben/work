<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        <title>聊天室</title>
        <style type="text/css">
			*{margin:0;padding:0;border:0;}
			body{background:#cc99ff;font-size:"微软雅黑";}
			h1{text-align:center;margin-top:10px;color:#006600;}
			#main {width:900px; height:500px; background:pink; margin:auto;
				margin-top:20px;border:1px solid #000;box-shadow:2px 2px 5px #000;}
			#left {width:200px; height:500px;background:#F5DEB3; float:left;}
			#right {width:700px; height:500px; background:rgb(206,263,49); float:left;}
			#content {height:379px; padding-top:1px;}
			#send {height:120px; background:rgb(51,175,234);}
			#control {position:relative; left:75px; top:18px;}
			select,textarea {border:1px solid gray;}
			#msg {width:410px;height:52px; margin-top:5px;}
			#content-title{color:green;font-size:14px;width:245px;margin:10px auto;}
			hr {border:1px solid gray; width:600px; margin:auto;}
			#show_msg {width:600px;height:328px;margin-left:47px;margin-top:10px;
				font-size:14px;font-weight:bold;overflow:auto;}
			#left h2 {color:#8B4513;font-size:14px;position:relative; left:36px;top:24px;		width:150px; }
			#left #user { position:relative; top:46px;left:48px;   }

			ul {font-size:12px;  list-style:none; width:110px; }

			#anniu {margin-top:280px; margin-left:50px; }
			#anniu input {margin-top:3px; width:98px;height:30px; background:#CD853F; color:white; border:2px solid white;}
			#notice{position:absolute;color:green;}
        </style>
    </head>


    <body>
		<div class="header">
			<h1>聊天室</h1>
		</div>
        <div id="main">
            <div id="left">
                <h2>在线名单：（5人）</h2>
                <ul id="user">
                    <li>帅哥：恶魔</li>
                    <li>靓妹：甜甜</li>
                    <li>帅哥：诸葛</li>
                    <li>帅哥：成就梦想</li>
                    <li>靓妹：郁金香</li>
                </ul>
                <ul id="anniu">
                    <li><input type="button" value="刷新名单" ></li>
                    <li><input type="button" value="刷新屏幕" ></li>
                    <li><input type="button" value="退出聊天" ></li>
                </ul>
            </div>
            <div id="right">
                <div id="content">
                    <h2 id="content-title">有什么意见和建议欢迎大家踊跃提出</h2>
                    <hr />
                    <div id="show_msg">
                        <p style="color:red">PHP爱好者聊天室公告：欢迎恶魔来到聊天室(22:05:35)</p>
                        <p>恶魔&nbsp;对&nbsp;大家&nbsp;微笑&nbsp;说：对啊(22:05:35)</p>
                        <p>恶魔&nbsp;对&nbsp;大家&nbsp;微笑&nbsp;说：对啊(22:05:35)</p>
                        <p style="color:#800080">恶魔&nbsp;对&nbsp;大家&nbsp;微笑&nbsp;说：好久不见了啊(22:05:35)</p>
                        <p style="color:red">PHP爱好者聊天室公告：欢迎天使来到聊天室(22:05:35)</p>
                        <p>天使&nbsp;对&nbsp;大家&nbsp;微笑&nbsp;说：你来了啊(22:05:35)</p>
                    </div>
                </div>
                <div id="send">
					<form method="post" action="">
						<div id="control">
							颜色：
							<select id="color" name="color">
								<option value="">请选择</option>
								<option	style="color:#FF8888" value="#FF8888">爱的暗示</option>
								<option	style="color:#00BBFF" value="#00BBFF">忧郁的蓝</option>
								<option	style="color:#0000FF" value="#0000FF">碧空蓝天</option>
								<option	style="color:#9F88FF" value="#9F88FF">灰蓝种族</option>
								<option	style="color:#000088" value="#000088 ">蔚蓝海洋</option>
								<option	style="color:#77FFEE" value="#77FFEE">清清之蓝</option>
								<option	style="color:#4400B3" value="#4400B3">发亮篮紫</option>
								<option	style="color:#A500CC" value="#A500CC">紫的拘谨</option>
								<option	style="color:#B088FF" value="#B088FF">卡其制服</option>
								<option	style="color:#D1BBFF" value="#D1BBFF">伦敦灰雾</option>
								<option	style="color:#DC143C" value="#DC143C">卡布其诺</option>
								<option	style="color:#A52A2A" value="#A52A2A">苦涩心红</option>
								<option	style="color:#FF0000" value="#FF0000">正宗喜红</option>
								<option	style="color:#990099" value="#990099">红的发紫</option>
								<option style="color:#FF0000" value="#FF0000">红旗飘飘</option>
								<option style="color:#D2691E" value="#D2691E ">黄金岁月</option>
								<option style="color:#800080" value="#800080">紫金绣贴</option>
								<option style="color:#006400" value="#006400">橄榄树绿</option>
								<option style="color:#000000" value="#000000">绝对黑色</option> 
							</select>
							表情：
							<select id="biaoqing" name="biaoqing">
								<option value="">请选择</option>
								<option value="笑着">笑着</option>
								<option value="高兴地">高兴地</option>
								<option value="含情脉脉">含情脉脉</option>
								<option value="微笑">微笑</option>
								<option value="幸福">幸福</option>
								<option value="有点脸红">有点脸红</option>
								<option value="使劲安慰">使劲安慰</option>
								<option value="自言自语">自言自语</option>
								<option value="差点要哭">差点要哭</option>
								<option value="嚎啕大哭">嚎啕大哭</option>
								<option value="一把鼻涕">一把鼻涕</option>
								<option value="很无辜">很无辜</option>
								<option value="流口水">流口水</option>
								<option value="神秘兮兮">神秘兮兮</option>
								<option value="幸灾乐祸">幸灾乐祸</option>
								<option value="很不服气">很不服气</option>
								<option value="不怀好意">不怀好意</option>
								<option value="拳打脚踢">拳打脚踢</option>
								<option value="不知所措">不知所措</option>
								<option value="翻箱倒柜">翻箱倒柜</option>
								<option value="很遗憾">很遗憾</option>
								<option value="很严肃">很严肃</option>
								<option value="善意警告">善意警告</option>
								<option value="正气凛然">正气凛然</option>
								<option value="哈欠连天">哈欠连天</option>
								<option value="小声的">小声的</option>
								<option value="大声的">大声的</option>
								<option value="尖叫一声">尖叫一声</option>
								<option value="遗憾的">遗憾的</option>
								<option value="无精打采">无精打采</option>
								<option value="想吐">想吐</option>
								<option value="真诚">真诚</option>
								<option value="不好意思">不好意思</option>
								<option value="扭捏的">扭捏的</option>
								<option value="腼腆的">腼腆的</option>
								<option value="很诧异">很诧异</option>
								<option value="依依不舍">依依不舍</option>
							</select>
							聊天对象：
							<select id="receiver" name="receiver">
								<option value="">所有的人</option> 
								<option value="恶魔">恶魔</option>
								<option value="甜甜">甜甜</option>
								<option value="诸葛">诸葛</option>
								<option value="成就梦想">成就梦想</option>
								<option value="郁金香">郁金香</option>
							</select>
							<br />
							<textarea id="msg" name="msg"></textarea>
							<input type="button" value="发送" onclick="sendMessages()"/>
							<span id="notice"></span>
						</div>
					</form>
                </div>
            </div>
        </div>

		<script type="text/javascript">
			var max_id = 0;  //必须声明在全局
			function showMessages(){
				var show_msg = document.getElementById("show_msg");

				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function(){
					if(xhr.readyState == 4){
						if(xhr.status == 200 || xhr.status == 304){
							//alert(xhr.responseText);
							var messages = JSON.parse(xhr.responseText); //[]
							var str = "";
							//alert(messages[0].sender);
							for(var i=0;i<messages.length;i++){
								str+="<p style='color:"+messages[i].color+"'>"+messages[i].sender+"&nbsp;对&nbsp;"+messages[i].receiver+"&nbsp;"+messages[i].biaoqing+"&nbsp;说："+messages[i].msg+"("+messages[i].add_time+")</p>";
								max_id = messages[i].id;
							}
							//console.log(max_id);
							show_msg.innerHTML += str;

							show_msg.scrollTop = show_msg.scrollHeight-328; 
							//alert(show_msg.scrollHeight); //元素的整体高度
						}
					}
				}
				xhr.open("get","./chart.php?maxId="+max_id);
				xhr.send(null);
			}
			window.onload = function(){
				showMessages();
				setInterval("showMessages()",2000);
				
			}

			function sendMessages(){
				var form = document.getElementsByTagName("form")[0];
				var fd = new FormData(form);
				
				var xhr = new XMLHttpRequest();
				xhr.open("post","./send.php");
				xhr.send(fd);
				xhr.onreadystatechange = function(){
					if(xhr.readyState == 4){
						if(xhr.status == 200 || xhr.status == 304){
							//alert(xhr.responseText);
							document.getElementById("notice").innerHTML=xhr.responseText;
							document.getElementById("color").value = "";
							document.getElementById("biaoqing").value = "";
							document.getElementById("receiver").value = "";
							document.getElementById("msg").value = "";
							
							setTimeout("hideNotice()",2000)
						}
					}
				}
			}
			function hideNotice(){
				document.getElementById("notice").innerHTML = '';
			}
        </script>
    </body>
</html>